---
- name: Create directories
  loop:
    - "{{ consul_certificate_ca_local_dir }}"
    - "{{ consul_certificate_entity_local_dir }}"
  run_once: true
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0700"
    state: directory

- name: Create CA certificate
  vars:
    common_certificate_ca_subject: "{{ consul_certificate_ca_subject }}"
    common_certificate_ca_duration: "{{ consul_certificate_ca_duration }}"
    common_certificate_ca_local_dir: "{{ consul_certificate_ca_local_dir }}"
  run_once: true
  ansible.builtin.include_tasks: "{{ (common_role_path, 'tasks/certificate/ca.yaml') | ansible.builtin.path_join }}"

- name: Create Consul entity certificates
  block:
    - name: Create Consul host certificate directory
      ansible.builtin.file:
        mode: "0755"
        path: "{{ consul_certificate_entity_host_local_dir }}"
        state: directory

    - name: Create Consul CLI certificate
      vars:
        common_certificate_entity_san: "{{ consul_certificate_entity_cli_san }}"
        common_certificate_entity_name: cli
        common_certificate_entity_subject: "{{ consul_certificate_entity_cli_subject }}"
        common_certificate_entity_duration: "{{ consul_certificate_entity_cli_duration }}"
        common_certificate_entity_dir: "{{ consul_certificate_entity_host_local_dir }}"
        common_certificate_entity_ca_dir: "{{ consul_certificate_ca_local_dir }}"
      ansible.builtin.include_tasks: "{{ (common_role_path, 'tasks/certificate/entity.yaml') | ansible.builtin.path_join }}"

    - name: Create Consul Client certificate
      when: not consul_config_server
      vars:
        common_certificate_entity_san: "{{ consul_certificate_entity_client_san }}"
        common_certificate_entity_name: client
        common_certificate_entity_subject: "{{ consul_certificate_entity_client_subject }}"
        common_certificate_entity_duration: "{{ consul_certificate_entity_client_duration }}"
        common_certificate_entity_dir: "{{ consul_certificate_entity_host_local_dir }}"
        common_certificate_entity_ca_dir: "{{ consul_certificate_ca_local_dir }}"
      ansible.builtin.include_tasks: "{{ (common_role_path, 'tasks/certificate/entity.yaml') | ansible.builtin.path_join }}"

    - name: Create Consul Server certificate
      when: consul_config_server
      vars:
        common_certificate_entity_san: "{{ consul_certificate_entity_server_san }}"
        common_certificate_entity_name: server
        common_certificate_entity_subject: "{{ consul_certificate_entity_server_subject }}"
        common_certificate_entity_duration: "{{ consul_certificate_entity_server_duration }}"
        common_certificate_entity_dir: "{{ consul_certificate_entity_host_local_dir }}"
        common_certificate_entity_ca_dir: "{{ consul_certificate_ca_local_dir }}"
      ansible.builtin.include_tasks: "{{ (common_role_path, 'tasks/certificate/entity.yaml') | ansible.builtin.path_join }}"
