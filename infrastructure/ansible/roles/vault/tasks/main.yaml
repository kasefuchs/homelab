---
- name: Download Vault
  tags: download
  ansible.builtin.include_tasks:
    file: download.yaml
    apply:
      tags: download
      become: false
      run_once: true
      delegate_to: localhost

- name: Install Vault
  tags: install
  ansible.builtin.include_tasks:
    file: install.yaml
    apply:
      tags: install

- name: Create Vault certificates
  tags: cert
  ansible.builtin.include_tasks:
    file: cert.yaml
    apply:
      tags: cert
      become: false
      delegate_to: localhost

- name: Setup Vault server
  tags: server
  when: vault_server_deploy
  block:
    - name: Create Vault server certificates
      tags: cert
      ansible.builtin.include_tasks:
        file: server/cert.yaml
        apply:
          tags:
            - cert
            - server
          become: false
          delegate_to: localhost

    - name: Configure Vault server
      tags: config
      ansible.builtin.include_tasks:
        file: server/config.yaml
        apply:
          tags:
            - server
            - config
          notify:
            - Reload SystemD daemon
            - Enable Vault server service
            - Restart Vault server service

    - name: Initialize Vault server
      tags: init
      when: vault_server_init_host == inventory_hostname
      ansible.builtin.include_tasks:
        file: server/init.yaml
        apply:
          tags:
            - init
            - server
          become: false
          delegate_to: localhost

    - name: Unseal Vault server
      tags: unseal
      ansible.builtin.include_tasks:
        file: server/unseal.yaml
        apply:
          tags:
            - unseal
            - server
          become: false
          delegate_to: localhost
