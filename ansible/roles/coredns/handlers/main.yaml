---
- name: Add CoreDNS Pebble layer
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.shell: >-
    {{ pebble_install_binary_file }} add {{ lookup('ansible.builtin.pipe', 'date +%s%N') }} {{ coredns_config_pebble_layer_file }} &&
    {{ pebble_install_binary_file }} replan

- name: Restart CoreDNS service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart coredns"

- name: Wait for CoreDNS
  ansible.builtin.wait_for:
    port: "{{ coredns_config_port }}"
