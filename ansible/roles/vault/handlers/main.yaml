---
- name: Add Vault server Pebble layer
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.shell: >-
    {{ pebble_install_binary_file }} add {{ lookup('ansible.builtin.pipe', 'date +%s%N') }} {{ vault_server_config_pebble_layer_file }} &&
    {{ pebble_install_binary_file }} replan

- name: Restart Vault server service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart vault"

- name: Wait for Vault server
  ansible.builtin.wait_for:
    port: "{{ vault_server_config_api_listen_port }}"

- name: Add Vault agent Pebble layer
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.shell: >-
    {{ pebble_install_binary_file }} add {{ lookup('ansible.builtin.pipe', 'date +%s%N') }} {{ vault_agent_config_pebble_layer_file }} &&
    {{ pebble_install_binary_file }} replan

- name: Restart Vault agent service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart vault-agent"
