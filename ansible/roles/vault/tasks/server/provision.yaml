---
- name: Include Vault initialization result
  run_once: true
  failed_when: false
  ansible.builtin.include_vars: "{{ vault_server_init_local_file }}"

- name: Wait until Vault cluster leader elected
  until: (vault_server_provision_status_result.stdout | ansible.builtin.from_json).leader_address is defined
  delay: 2
  retries: 30
  register: vault_server_provision_status_result
  failed_when: vault_server_provision_status_result.rc == 1
  changed_when: false
  environment:
    VAULT_ADDR: "{{ vault_server_local_address }}"
    VAULT_CACERT: "{{ (vault_server_cert_ca_local_dir, 'server.crt') | ansible.builtin.path_join }}"
  ansible.builtin.command:
    cmd: vault status -format=json

- name: Ensure Vault provision directory exists
  ansible.builtin.file:
    path: "{{ vault_server_provision_local_dir }}"
    state: directory
    mode: "0700"

- name: Provision Vault server
  register: vault_server_provision_result
  environment:
    VAULT_ADDR: "{{ vault_server_local_address }}"
    VAULT_TOKEN: "{{ vault_server_local_token }}"
    VAULT_CACERT: "{{ (vault_server_cert_ca_local_dir, 'server.crt') | ansible.builtin.path_join }}"
  community.general.terraform:
    project_path: "{{ vault_server_provision_terraform_local_dir }}"
    workspace: "{{ common_inventory_name }}"
    force_init: true

- name: Render Vault provision result to local YAML file
  vars:
    common_managed_content: |
      ---
      {{
        {"vault_server_provision_data": vault_server_provision_result.outputs}
        | ansible.builtin.to_nice_yaml(indent=2)
      }}
  ansible.builtin.template:
    src: "{{ common_template_managed_local_path }}"
    dest: "{{ vault_server_provision_local_file }}"
    mode: "0600"

- name: Copy Vault PKI CA certificates
  loop:
    - name: root
      value: "{{ vault_server_provision_result.outputs.vault_pki_root_ca_certificate.value }}"
    - name: cluster
      value: "{{ vault_server_provision_result.outputs.vault_pki_cluster_ca_certificate.value }}"
  loop_control:
    label: "{{ item.name }}"
  vars:
    common_managed_content: "{{ item.value }}"
  ansible.builtin.template:
    src: "{{ common_template_managed_local_path }}"
    dest: "{{ (vault_server_cert_ca_local_dir, item.name ~ '.crt') | ansible.builtin.path_join }}"
    mode: "0644"
