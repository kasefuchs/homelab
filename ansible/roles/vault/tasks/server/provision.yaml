---
- name: Include Vault initialization result
  ansible.builtin.include_vars:
    file: "{{ vault_server_init_local_file }}"

- name: Ensure Vault provision directory exists
  ansible.builtin.file:
    path: "{{ vault_server_provision_local_dir }}"
    state: directory
    mode: "0700"

- name: Provision Vault server
  register: vault_server_provision_result
  environment:
    VAULT_ADDR: "{{ vault_server_local_api_address }}"
    VAULT_TOKEN: "{{ vault_server_init_data.root_token }}"
    VAULT_CACERT: "{{ (vault_cert_ca_local_dir, 'ca.crt') | ansible.builtin.path_join }}"
  community.general.terraform:
    project_path: "{{ vault_server_provision_terraform_local_dir }}"
    workspace: "{{ common_inventory_name }}"

- name: Render Vault provision result to local YAML file
  vars:
    common_managed_content: |
      ---
      {{
        {"vault_server_provision_data": vault_server_provision_result.outputs}
        | ansible.builtin.to_nice_yaml(indent=2)
      }}
  ansible.builtin.template:
    src: "{{ common_template_managed_local_path }}"
    dest: "{{ vault_server_provision_local_file }}"
    mode: "0600"
