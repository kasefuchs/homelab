---
- name: Download Vault
  tags: [download, packer]
  ansible.builtin.include_tasks:
    file: download.yaml
    apply:
      tags: [download, packer]
      become: false
      run_once: true
      delegate_to: localhost

- name: Install Vault
  tags: [install, packer]
  ansible.builtin.include_tasks:
    file: install.yaml
    apply:
      tags: [install, packer]

- name: Create Vault certificates
  tags: cert
  ansible.builtin.include_tasks:
    file: cert.yaml
    apply:
      tags: cert
      become: false
      delegate_to: localhost

- name: Setup Vault server
  tags: server
  when: vault_server_deploy
  block:
    - name: Create Vault server certificates
      tags: [server, cert]
      ansible.builtin.include_tasks:
        file: server/cert.yaml
        apply:
          tags: [server, cert]
          become: false
          delegate_to: localhost

    - name: Configure Vault server
      tags: [server, config]
      ansible.builtin.include_tasks:
        file: server/config.yaml
        apply:
          tags: [server, config]
          notify:
            - Restart Vault server service
            - Wait for Vault server

    - name: Initialize Vault server
      tags: [server, init]
      when: vault_server_init_host == inventory_hostname
      ansible.builtin.include_tasks:
        file: server/init.yaml
        apply:
          tags: [server, init]
          become: false
          delegate_to: localhost

    - name: Unseal Vault server
      tags: [server, unseal]
      ansible.builtin.include_tasks:
        file: server/unseal.yaml
        apply:
          tags: [server, unseal]
          become: false
          delegate_to: localhost

    - name: Provision Vault server
      tags: [server, provision]
      when: vault_server_provision_host == inventory_hostname
      ansible.builtin.include_tasks:
        file: server/provision.yaml
        apply:
          tags: [server, provision]
          become: false
          delegate_to: localhost

- name: Setup Vault agent
  tags: agent
  block:
    - name: Configure Vault agent
      tags: [agent, config]
      ansible.builtin.include_tasks:
        file: agent/config.yaml
        apply:
          tags: [agent, config]
          notify:
            - Restart Vault agent service
