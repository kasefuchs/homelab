---
- name: Get latest release of a public repository
  when: vault_version == "latest"
  run_once: true
  register: vault_github_release
  delegate_to: localhost
  community.general.github_release:
    user: "{{ vault_github_user }}"
    repo: "{{ vault_github_repository }}"
    action: latest_release

- name: Gather Vault facts
  block:
    - name: Gather Vault download facts
      ansible.builtin.set_fact:
        vault_version: "{{ vault_github_release.tag | default(vault_version) | regex_replace('^v', '') }}"
        vault_architecture: "{{ vault_architectures[ansible_architecture] }}"

    - name: Set Vault package directory fact
      ansible.builtin.set_fact:
        vault_version_dir: "{{ (vault_package_dir, vault_version) | ansible.builtin.path_join }}"

    - name: Set Vault path fact
      ansible.builtin.set_fact:
        vault_binary_path: "{{ (vault_version_dir, 'vault') | ansible.builtin.path_join }}"
        vault_config_path: "{{ (vault_config_dir, 'vault.hcl') | ansible.builtin.path_join }}"

- name: Create Vault package directory
  ansible.builtin.file:
    mode: "0755"
    path: "{{ vault_version_dir }}"
    state: directory

- name: Download & extract Vault package
  ansible.builtin.unarchive:
    src: "{{ vault_download_url }}"
    dest: "{{ vault_version_dir }}"
    creates: "{{ vault_binary_path }}"
    remote_src: true
