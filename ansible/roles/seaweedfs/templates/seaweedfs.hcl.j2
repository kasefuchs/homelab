{%- macro service_basic(name, type) -%}
  id   = "seaweedfs-{{ name }}-{{ type }}"
  name = "seaweedfs-{{ name }}"
  tags = ["{{ type }}"]
{%- endmacro -%}

{%- macro service_address(port) -%}
  address = "{{ nebula_ip | ansible.utils.ipaddr('address') }}"
  port    = {{ port }}
{%- endmacro -%}

{%- macro service_http_check(name, port, path) -%}
  check = {
    id       = "seaweedfs-{{ name }}-http-check"
    name     = "{{ name }} http check"
    http     = "http://{{ nebula_ip | ansible.utils.ipaddr('address') }}:{{ port }}/{{ path }}"
    timeout  = "1s"
    interval = "10s"
  }
{%- endmacro -%}

{%- macro service_tcp_check(name, port) -%}
  check = {
    id       = "seaweedfs-{{ name }}-tcp-check"
    name     = "{{ name }} tcp check"
    tcp      = "{{ nebula_ip | ansible.utils.ipaddr('address') }}:{{ port }}"
    timeout  = "1s"
    interval = "10s"
  }
{%- endmacro -%}

{%- if seaweedfs_master %}
services {
  {{ service_basic("master", "http") }}
  {{ service_address(9333) }}
  {{ service_http_check("master", 9333, "cluster/healthz") }}
}
services {
  {{ service_basic("master", "grpc") }}
  {{ service_address(19333) }}
  {{ service_tcp_check("master", 19333) }}
}
{% endif %}

{%- if seaweedfs_volume %}
services {
  {{ service_basic("volume", "http") }}
  {{ service_address(8080) }}
  {{ service_http_check("volume", 8080, "healthz") }}
}
services {
  {{ service_basic("volume", "grpc") }}
  {{ service_address(18080) }}
  {{ service_tcp_check("volume", 18080) }}
}
{% endif %}

{%- if seaweedfs_filer %}
services {
  {{ service_basic("filer", "http") }}
  {{ service_address(8888) }}
  {{ service_http_check("filer", 8888, "healthz") }}
}
services {
  {{ service_basic("filer", "grpc") }}
  {{ service_address(18888) }}
  {{ service_tcp_check("filer", 18888) }}
}
{% endif %}
