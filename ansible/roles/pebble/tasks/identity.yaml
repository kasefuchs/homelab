---
- name: Create temporary Pebble identities file
  register: pebble_identity_tempfile
  changed_when: false
  ansible.builtin.tempfile:
    state: file

- name: Write temporary Pebble identities config
  ansible.builtin.template:
    src: identity.yaml.j2
    dest: "{{ pebble_identity_tempfile.path }}"
    mode: "0644"
    owner: root
    group: root

- name: Replace Pebble identities
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command:
    cmd: "{{ pebble_install_binary_file }} update-identities --from {{ pebble_identity_tempfile.path }} --replace"

- name: Remove temporary Pebble identities config
  ansible.builtin.file:
    path: "{{ pebble_identity_tempfile.path }}"
    state: absent
