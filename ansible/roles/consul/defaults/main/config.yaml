---
# Whether this node is a Consul server.
consul_config_server: "{{ 'consul_servers' in group_names }}"

# List of servers to join at startup, excluding this node.
consul_config_retry_join: "{{ groups['consul_servers'] | reject('equalto', inventory_hostname) | map('regex_replace', '^(.*)$', '\\1.internal') }}"

# Number of servers expected to bootstrap the cluster.
consul_config_bootstrap_expect: "{{ groups['consul_servers'] | length }}"

# Unique node name, usually the hostname.
consul_config_node_name: "{{ inventory_hostname }}"

# Datacenter name.
consul_config_datacenter: global

# Address for binding internal cluster communications.
consul_config_bind_address: 0.0.0.0

# Address for client requests.
consul_config_client_address: 0.0.0.0

# The address to advertise to other nodes in the cluster.
consul_config_advertise_address: "{{ ansible_default_ipv4.address }}"

# Disables automatic checking for new version releases.
consul_config_disable_update_check: true

# Consul UI config.
consul_config_ui:
  enabled: true

# Default addresses config.
consul_config_addresses:
  dns: 127.0.0.1

# Consul ports.
consul_config_ports:
  dns: 8600
  http: -1
  https: 8501
  grpc: -1
  grpc_tls: 8503

# Consul Telemetry config.
consul_config_telemetry:
  prometheus_retention_time: 1m
  disable_hostname: true

# Vault agent templates for certificates and secrets.
consul_config_vault_agent_templates:
  consul-agent-cert:
    contents: "{{ lookup('ansible.builtin.template', 'agent.pem.ctmpl.j2') }}"
    destination: "{{ (consul_config_cert_entity_dir, 'agent.pem') | ansible.builtin.path_join }}"
    user: "{{ consul_install_user }}"
    group: "{{ consul_install_group }}"
    perms: 384
    exec:
      command: ["sh", "-c", "PEBBLE={{ pebble_config_state_dir }} {{ pebble_install_binary_file }} signal HUP consul || true"]
    left_delimiter: "[["
    right_delimiter: "]]"

  consul-agent-vault-secrets:
    contents: "{{ lookup('ansible.builtin.template', 'vault.hcl.ctmpl.j2') }}"
    destination: "{{ consul_config_vault_file }}"
    user: "{{ consul_install_user }}"
    group: "{{ consul_install_group }}"
    perms: 384
    left_delimiter: "[["
    right_delimiter: "]]"

# CN for server certificate.
consul_config_cert_entity_server_cn: "server.{{ consul_config_datacenter }}.consul"

# DNS SANs for server certificate.
consul_config_cert_entity_server_dns_sans:
  - localhost
  - consul.service.consul
  - "{{ common_internal_fqdn }}"
  - "server.{{ consul_config_datacenter }}.consul"
  - "{{ consul_config_node_name }}.server.{{ consul_config_datacenter }}.consul"

# CN for client certificate.
consul_config_cert_entity_client_cn: "client.{{ consul_config_datacenter }}.consul"

# DNS SANs for client certificate.
consul_config_cert_entity_client_dns_sans:
  - localhost
  - "{{ common_internal_fqdn }}"
  - "client.{{ consul_config_datacenter }}.consul"
  - "{{ consul_config_node_name }}.client.{{ consul_config_datacenter }}.consul"

# CN based on node role.
consul_config_cert_entity_cn: "{{ consul_config_cert_entity_server_cn if consul_config_server else consul_config_cert_entity_client_cn }}"

# Certificate validity duration.
consul_config_cert_entity_duration: 168h

# IP addresses included in the certificate.
consul_config_cert_entity_ip_sans:
  - 127.0.0.1
  - "{{ ansible_default_ipv4.address }}"

# DNS SANs based on node role.
consul_config_cert_entity_dns_sans: "{{ consul_config_cert_entity_server_dns_sans if consul_config_server else consul_config_cert_entity_client_dns_sans }}"

# List of services that service depends on for startup ordering.
consul_config_service_dependencies: [coredns, vault-agent]
