---
- name: Include Vault initialization result
  run_once: true
  failed_when: false
  ansible.builtin.set_fact:
    consul_vault_server_init_data: "{{ lookup('community.sops.sops', vault_server_init_encrypted_local_file) | ansible.builtin.from_json }}"

- name: Prepare Consul
  environment:
    VAULT_ADDR: "{{ consul_local_vault_address }}"
    VAULT_TOKEN: "{{ consul_local_vault_token }}"
    VAULT_CACERT: "{{ (vault_server_cert_ca_local_dir, 'server.crt') | ansible.builtin.path_join }}"
  community.general.terraform:
    project_path: "{{ consul_prepare_terraform_local_dir }}"
    workspace: "{{ common_inventory_name }}"
    force_init: true
