---
- name: Edit Consul service
  notify:
    - Reload Daemon
    - Enable Consul
    - Start Consul
  block:
    - name: Create Consul service directory
      ansible.builtin.file:
        path: /etc/systemd/system/consul.service.d/
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy Consul override service
      ansible.builtin.copy:
        src: override.conf
        dest: /etc/systemd/system/consul.service.d/override.conf
        owner: root
        group: root
        mode: "0644"

- name: Copy Consul config files
  notify: Reload Consul
  block:
    - name: Consul common config
      ansible.builtin.template:
        src: consul.hcl.j2
        dest: /etc/consul.d/consul.hcl
        mode: "0644"
        owner: consul
        group: consul

    - name: Consul server-only config
      ansible.builtin.template:
        src: server.hcl.j2
        dest: /etc/consul.d/server.hcl
        mode: "0644"
        owner: consul
        group: consul
      when: consul_server | bool

    - name: Consul client-only config
      ansible.builtin.template:
        src: client.hcl.j2
        dest: /etc/consul.d/client.hcl
        mode: "0644"
        owner: consul
        group: consul
      when: consul_client | bool

- name: Ensure handlers to run
  ansible.builtin.meta: flush_handlers
