---
- name: Download Consul
  tags: [download, packer]
  ansible.builtin.include_tasks:
    file: download.yaml
    apply:
      tags: [download, packer]
      become: false
      run_once: true
      delegate_to: localhost

- name: Install Consul
  tags: [install, packer]
  ansible.builtin.include_tasks:
    file: install.yaml
    apply:
      tags: [install, packer]

- name: Configure Consul agent
  tags: config
  ansible.builtin.include_tasks:
    file: config.yaml
    apply:
      tags: config
      notify:
        - Restart Consul agent service
        - Wait for Consul agent

- name: Bootstrap Consul ACL
  tags: bootstrap
  when: consul_bootstrap_host == inventory_hostname
  ansible.builtin.include_tasks:
    file: bootstrap.yaml
    apply:
      tags: bootstrap
      become: false
      delegate_to: localhost

- name: Provision Consul
  tags: provision
  when: consul_provision_host == inventory_hostname
  ansible.builtin.include_tasks:
    file: provision.yaml
    apply:
      tags: provision
      become: false
      delegate_to: localhost

- name: Configure Consul ACl
  tags: acl
  ansible.builtin.include_tasks:
    file: acl.yaml
    apply:
      tags: acl
      become: false
      delegate_to: localhost
