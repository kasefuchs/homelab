---
- name: Restart Vault agent service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart vault-agent"

- name: Add Consul agent Pebble layer
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.shell: >-
    {{ pebble_install_binary_file }} add {{ lookup('ansible.builtin.pipe', 'date +%s%N') }} {{ consul_config_pebble_layer_file }} &&
    {{ pebble_install_binary_file }} replan

- name: Restart Consul agent service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart consul"

- name: Wait for Consul agent
  ansible.builtin.wait_for:
    port: "{{ consul_config_ports.https }}"
