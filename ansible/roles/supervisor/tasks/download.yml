---
- name: Receive Supervisor latest version
  run_once: true
  when: supervisor_version == "latest"
  block:
    - name: Fetch Supervisor PyPi package info
      register: supervisor_pypi_response
      ansible.builtin.uri:
        url: https://pypi.org/pypi/{{ supervisor_package }}/json
        status_code: 200
        return_content: true

    - name: Set latest Supervisor version
      ansible.builtin.set_fact:
        supervisor_version: "{{ supervisor_pypi_response.json.info.version }}"

- name: Set Supervisor version directory fact
  run_once: true
  ansible.builtin.set_fact:
    supervisor_version_dir: "{{ (supervisor_package_dir, supervisor_version) | ansible.builtin.path_join }}"

- name: Download Supervisor
  block:
    - name: Create Supervisor version directory
      ansible.builtin.file:
        mode: "0755"
        path: "{{ supervisor_version_dir }}"
        state: directory

    - name: Install Supervisor Python package
      ansible.builtin.pip:
        name: "{{ supervisor_package }}"
        virtualenv: "{{ supervisor_version_dir }}"
        virtualenv_command: "{{ ansible_python.executable }} -m venv"

- name: Prepare Supervisor for use
  block:
    - name: Link Supervisor current version directory
      ansible.builtin.file:
        src: "{{ supervisor_version_dir }}"
        dest: "{{ supervisor_current_dir }}"
        state: link
