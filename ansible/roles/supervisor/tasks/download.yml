---
- name: Receive Supervisor latest version
  run_once: true
  when: supervisor_version == "latest"
  block:
    - name: Fetch Supervisor PyPi package info
      register: supervisor_pypi_response
      ansible.builtin.uri:
        url: https://pypi.org/pypi/{{ supervisor_package }}/json
        status_code: 200
        return_content: true

    - name: Set latest Supervisor version
      ansible.builtin.set_fact:
        supervisor_version: "{{ supervisor_pypi_response.json.info.version }}"

- name: Gather Supervisor facts
  block:
    - name: Set Supervisor package directory fact
      ansible.builtin.set_fact:
        supervisor_version_dir: "{{ (supervisor_package_dir, supervisor_version) | ansible.builtin.path_join }}"
        supervisor_binary_dir: "{{ (supervisor_package_dir, supervisor_version, 'bin') | ansible.builtin.path_join }}"

    - name: Set Supervisor package path fact
      ansible.builtin.set_fact:
        supervisor_daemon_bin: "{{ (supervisor_binary_dir, 'supervisord') | ansible.builtin.path_join }}"
        supervisor_control_bin: "{{ (supervisor_binary_dir, 'supervisorctl') | ansible.builtin.path_join }}"

- name: Create Supervisor package directory
  ansible.builtin.file:
    mode: "0755"
    path: "{{ supervisor_version_dir }}"
    state: directory

- name: Install Supervisor Python package
  ansible.builtin.pip:
    name: "{{ supervisor_package }}"
    virtualenv: "{{ supervisor_version_dir }}"
