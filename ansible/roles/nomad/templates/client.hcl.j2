client {
  enabled = true
  servers = [
{% for ip in hostvars | community.general.json_query('* | [?nomad_server].ansible_all_ipv4_addresses[] | [?starts_with(@, `100.`)]') %}
    "{{ ip }}",
{% endfor %}
  ]
  host_network "tailscale" {
    interface = "tailscale0"
  }
  meta {
{% if nomad_meta_geoip %}
{% for key, value in lookup('ansible.utils.to_paths', ipinfo.json, prepend='geoip').items() %}
    "{{ key }}" = "{{ value | regex_replace('"', '\\"') }}"
{% endfor %}
{% endif %}
  }
}

plugin "docker" {
  config {
    allow_privileged = true
  }
}
