---
- name: Include vars
  loop:
    - "{{ vault_server_init_local_file }}"
    - "{{ consul_bootstrap_local_file }}"
  run_once: true
  failed_when: false
  ansible.builtin.include_vars: "{{ item }}"

- name: Prepare Nomad
  environment:
    VAULT_ADDR: "{{ nomad_local_vault_address }}"
    VAULT_TOKEN: "{{ nomad_local_vault_token }}"
    VAULT_CACERT: "{{ (vault_server_cert_ca_local_dir, 'server.crt') | ansible.builtin.path_join }}"
    CONSUL_HTTP_ADDR: "{{ nomad_local_consul_address }}"
    CONSUL_HTTP_TOKEN: "{{ nomad_local_consul_token }}"
    CONSUL_CACERT: "{{ (vault_server_cert_ca_local_dir, 'intermediate.crt') | ansible.builtin.path_join }}"
  community.general.terraform:
    project_path: "{{ nomad_prepare_terraform_local_dir }}"
    workspace: "{{ common_inventory_name }}"
