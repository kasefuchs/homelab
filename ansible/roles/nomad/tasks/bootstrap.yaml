---
- name: Ensure Nomad bootstrap directory exists
  ansible.builtin.file:
    path: "{{ nomad_bootstrap_local_dir }}"
    state: directory
    mode: "0700"

- name: Wait until Nomad cluster leader elected
  until: nomad_bootstrap_leader_result.status == 200
  delay: 2
  retries: 30
  register: nomad_bootstrap_leader_result
  changed_when: false
  ansible.builtin.uri:
    url: "{{ nomad_local_address }}/v1/status/leader"
    ca_path: "{{ (vault_server_cert_ca_local_dir, 'cluster.crt') | ansible.builtin.path_join }}"

- name: Bootstrap Nomad ACL
  run_once: true
  block:
    - name: Run Nomad ACL bootstrap command
      register: nomad_bootstrap_result
      failed_when: false
      changed_when: nomad_bootstrap_result.rc == 0
      environment:
        NOMAD_ADDR: "{{ nomad_local_address }}"
        NOMAD_CACERT: "{{ (vault_server_cert_ca_local_dir, 'cluster.crt') | ansible.builtin.path_join }}"
      ansible.builtin.command: nomad acl bootstrap -json

    - name: Render Nomad ACL bootstrap output to local YAML file
      when: nomad_bootstrap_result.rc == 0
      vars:
        common_managed_content: |
          ---
          {{
            {"nomad_bootstrap_data": nomad_bootstrap_result.stdout | ansible.builtin.from_json}
            | ansible.builtin.to_nice_yaml(indent=2)
          }}
      ansible.builtin.template:
        src: "{{ common_template_managed_local_path }}"
        dest: "{{ nomad_bootstrap_local_file }}"
        mode: "0600"
