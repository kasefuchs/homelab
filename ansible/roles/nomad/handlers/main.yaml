---
- name: Restart Vault agent service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart vault-agent"

- name: Add Nomad agent Pebble layer
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.shell: >-
    {{ pebble_install_binary_file }} add {{ lookup('ansible.builtin.pipe', 'date +%s%N') }} {{ nomad_config_pebble_layer_file }} &&
    {{ pebble_install_binary_file }} replan

- name: Restart Nomad agent service
  environment:
    PEBBLE: "{{ pebble_config_state_dir }}"
  changed_when: false
  ansible.builtin.command: "{{ pebble_install_binary_file }} restart nomad"

- name: Wait for Nomad agent
  ansible.builtin.wait_for:
    port: "{{ nomad_config_ports.http }}"
