---
- name: Add package repositories
  block:
    - name: Add package repositories (APT-like)
      when: ansible_pkg_mgr == "apt"
      block:
        - name: Ensure keyring directory exists
          ansible.builtin.file:
            path: "{{ bootstrap_package_apt_keyring_dir }}"
            mode: "0755"
            state: directory

        - name: Add repositories signing keys
          loop: "{{ bootstrap_package_apt_repositories | ansible.builtin.dict2items }}"
          loop_control:
            label: "{{ item.key }}"
          ansible.builtin.get_url:
            url: "{{ item.value.key }}"
            dest: "{{ (bootstrap_package_apt_keyring_dir, item.key) | ansible.builtin.path_join }}"
            mode: "0644"
            force: "{{ item.value.force | default(False) }}"

        - name: Add package repositories
          loop: "{{ bootstrap_package_apt_repositories | ansible.builtin.dict2items }}"
          loop_control:
            label: "{{ item.key }}"
          ansible.builtin.apt_repository:
            repo: "deb [signed-by={{ (bootstrap_package_apt_keyring_dir, item.key) | ansible.builtin.path_join }}] {{ item.value.url }} {{ ansible_distribution_release
              }} {{ item.value.components | join(' ') }}"
            filename: "{{ item.key }}"
            update_cache: false

- name: Update package cache
  ansible.builtin.package:
    update_cache: "{{ bootstrap_package_update_cache }}"

- name: Install packages
  ansible.builtin.package:
    name: "{{ bootstrap_package_install | reject('equalto', omit) }}"

- name: Remove package cache
  when: bootstrap_package_remove_cache
  block:
    - name: Remove APT package cache
      when: ansible_pkg_mgr == "apt"
      ansible.builtin.apt:
        clean: true
